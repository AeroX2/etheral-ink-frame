from shlex import quote
import subprocess

from celery import shared_task, Celery
from config import settings

app = FastAPI()

celery = Celery(
    __name__,
    broker=settings.CELERY_BROKER_URL,
    backend=settings.CELERY_RESULT_BACKEND
)

@celery.task
def generate_image(prompt: str, output_file_path: str):
    command = './sd --turbo --prompt {} --models-path sdxlturbo --steps 1 --output {}'.format(quote(prompt), quote(output_file_path))
    process = subprocess.Popen(command, stdout=subprocess.PIPE, stderr=subprocess.PIPE, text=True)

    while True:
        output_line = process.stdout.readline()
        if output_line == '' and process.poll() is not None:
            break

        print("Output:", output_line.strip())

        error_line = process.stderr.readline()
        if error_line == '' and process.poll() is not None:
            break

         print("Error:", error_line.strip())

    process.wait()
